name: Check External References
on:
  workflow_dispatch: # Manuelles Auslösen
  schedule:
    - cron: "0 7 * * *" # Täglich um 7 Uhr UTC

jobs:
  check-and-update:
    runs-on: ubuntu-latest # Enthält schon Podman vorinstalliert
    permissions:
      contents: write # Erforderlich zum Pushen von Änderungen
    steps:
      - uses: actions/checkout@v4

      - name: Get latest go dependencies versions
        id: go
        run: |
          # Get latest tag for caddy-crowdsec-bouncer
          tag1=$(git ls-remote --tags https://github.com/hslatman/caddy-crowdsec-bouncer.git | \
            awk -F/ '{print $3}' | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          # Get latest tag for caddy-dns-inwx
          tag2=$(git ls-remote --tags https://github.com/caddy-dns/inwx.git | \
            awk -F/ '{print $3}' | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          echo "caddy-crowdsec-bouncer=$tag1" >> $GITHUB_OUTPUT
          echo "caddy-dns-inwx=$tag2" >> $GITHUB_OUTPUT

      - name: Get latest container image version label with Podman # Does not work to get the labels. Check the command.
        id: image
        run: |
          podman pull docker.io/caddy:builder
          version=$(podman inspect --format '{{range .Config.Env}}{{if (eq (index (split . "=") 0) "CADDY_VERSION")}}{{index (split . "=") 1}}{{end}}{{end}}' docker.io/caddy:builder)
          echo "caddy-image=$version" >> $GITHUB_OUTPUT

      - name: Compare and update refs.txt if needed
        id: update
        run: |

          if [ -f refs.txt ]; then
            file=refs.txt
            . <(sed 's/-/_/g' "$file")
          fi
          changed=0

          #caddy-crowdsec-bouncer
          if [ "$caddy-crowdsec-bouncer" != "${{ steps.go.outputs.caddy-crowdsec-bouncer }}" ]; then
            sed -i "/^caddy-crowdsec-bouncer=/d" $file
            echo "caddy-crowdsec-bouncer=${{ steps.go.outputs.caddy-crowdsec-bouncer }}" >> $file
            changed=1
          fi

          #caddy-dns-inwx
          if [ "$caddy-dns-inwx" != "${{ steps.go.outputs.caddy-dns-inwx }}" ]; then
            sed -i "/^caddy-dns-inwx=/d" $file
            echo "caddy-dns-inwx=${{ steps.go.outputs.caddy-dns-inwx }}" >> $file
            changed=1
          fi

          #caddy-image
          if [ "$caddy-image" != "${{ steps.image.outputs.caddy-image }}" ]; then
            sed -i "/^container-image-tag=/d" $file
            echo "caddy-image=${{ steps.image.outputs.caddy-image }}" >> $file
            changed=1
          fi

          echo "changed=$changed" >> $GITHUB_OUTPUT

      - name: Commit and push refs.txt
        if: steps.update.outputs.changed == '1'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.email "bot@altmann.it"
          git config --global user.name "GitHub Actions Bot"
          git add refs.txt
          git commit -m "Update external references"
          git push
